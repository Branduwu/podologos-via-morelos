---
import "../styles/global.css";
import { clinic } from "../config/clinic";
import { getBusinessInfo } from "../lib/sanity.js";
import { resolveWhatsAppNumber, resolveWhatsAppReason } from "../utils/whatsapp";

const {
  title: titleProp,
  description: descriptionProp,
  image,
} = Astro.props;

const business = await getBusinessInfo();
const waNumber = resolveWhatsAppNumber(
  business?.whatsappCitasNumber,
  clinic.whatsappNumber
);
const waMessage = encodeURIComponent(
  resolveWhatsAppReason(
    business?.whatsappGeneralMessage,
    "Quiero informacion y disponibilidad para agendar una cita.",
    {
      business: business?.name || clinic.name,
      problem: business?.whatsappQuickProblemDefault || "",
    }
  )
);
const waLink = waNumber ? `https://wa.me/${waNumber}?text=${waMessage}` : null;
const siteUrl = Astro.site || new URL("http://localhost:4321");
const canonical = new URL(Astro.url?.pathname || "/", siteUrl).toString();
const metaTitle = titleProp || business?.socialShareTitle || "Podologos Via Morelos Tulpetlac";
const metaDescription =
  descriptionProp ||
  business?.socialShareDescription ||
  "Podologia, Psicologia, Optica, Quiropractica y Dentista en Tulpetlac y alrededores.";
const ogImage = image || business?.socialShareImageUrl || business?.homeHeroImageUrl || "/default-logo-clinica.svg";
const ogImageUrl = ogImage.startsWith("http") ? ogImage : new URL(ogImage, siteUrl).toString();

const localBusinessLd = {
  "@context": "https://schema.org",
  "@type": "MedicalBusiness",
  name: business?.name || "Podologos Via Morelos Tulpetlac",
  image: business?.logoImageUrl || ogImageUrl,
  telephone: business?.phone || undefined,
  address: business?.address
    ? { "@type": "PostalAddress", streetAddress: business.address, addressCountry: "MX" }
    : undefined,
  openingHours: business?.hoursText || undefined,
  sameAs: [business?.facebookUrl, business?.instagramUrl, business?.tiktokUrl].filter(Boolean),
  url: canonical,
};
---

<!doctype html>
<html lang="es" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{metaTitle}</title>
    <meta name="description" content={metaDescription} />
    <link rel="canonical" href={canonical} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={ogImageUrl} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImageUrl} />
    <link rel="preload" as="image" href="/placeholder.jpg" />
    <link id="theme-favicon" rel="icon" type="image/svg+xml" href="/favicon-light.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Source+Sans+3:wght@400;500;600;700&display=swap"
    />

    <script is:inline>
      (() => {
        const key = "theme";
        const saved = localStorage.getItem(key);
        const theme = saved ?? "light";
        if (theme === "dark") document.documentElement.classList.add("dark");
        document.documentElement.classList.add("h-full");

        const favicon = document.getElementById("theme-favicon");
        if (favicon) favicon.setAttribute("href", theme === "dark" ? "/favicon-dark.svg" : "/favicon-light.svg");
      })();
    </script>
    <script is:inline type="application/ld+json" set:html={JSON.stringify(localBusinessLd)}></script>
  </head>

  <body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
    <a href="#contenido-principal" class="sr-only focus:not-sr-only focus:fixed focus:left-3 focus:top-3 focus:z-[120] focus:rounded-lg focus:bg-white focus:px-3 focus:py-2 focus:text-sm focus:font-semibold focus:text-slate-900">
      Saltar al contenido principal
    </a>
    <div class="flex min-h-screen flex-col">
      <slot />
    </div>
    {waLink && (
      <a
        href={waLink}
        target="_blank"
        rel="noopener noreferrer"
        class="fixed bottom-5 right-4 z-[70] inline-flex h-12 w-12 items-center justify-center rounded-full bg-emerald-500 text-white shadow-[0_14px_30px_-16px_rgba(16,185,129,0.95)] ring-4 ring-emerald-100 transition hover:-translate-y-0.5 hover:bg-emerald-600 hover:shadow-[0_20px_34px_-14px_rgba(16,185,129,0.95)] dark:ring-emerald-900/40"
        aria-label="Abrir WhatsApp"
        title="Enviar WhatsApp"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6" fill="currentColor" aria-hidden="true">
          <path d="M19.05 4.94A9.86 9.86 0 0 0 12.03 2a9.94 9.94 0 0 0-8.59 14.95L2 22l5.22-1.37a9.9 9.9 0 0 0 4.78 1.22h.01c5.5 0 9.97-4.47 9.97-9.97 0-2.66-1.04-5.17-2.93-6.94Zm-7.04 15.2h-.01a8.2 8.2 0 0 1-4.18-1.15l-.3-.18-3.1.82.83-3.03-.2-.31a8.22 8.22 0 0 1-1.27-4.37c0-4.53 3.68-8.21 8.22-8.21 2.2 0 4.25.86 5.8 2.41a8.18 8.18 0 0 1 2.4 5.8c0 4.52-3.68 8.2-8.19 8.2Zm4.5-6.17c-.25-.13-1.47-.73-1.7-.81-.22-.08-.39-.12-.55.12-.17.25-.64.8-.79.97-.14.16-.28.18-.52.06-.24-.13-1.02-.38-1.93-1.2a7.28 7.28 0 0 1-1.33-1.66c-.14-.24-.01-.37.1-.49.11-.11.25-.28.37-.42.12-.14.15-.24.23-.4.08-.17.04-.3-.02-.43-.06-.12-.56-1.34-.77-1.84-.2-.49-.4-.42-.55-.43h-.48c-.16 0-.43.06-.64.3-.22.24-.84.82-.84 2.01 0 1.18.86 2.32.98 2.48.12.16 1.69 2.58 4.1 3.61.57.25 1.01.4 1.37.52.58.18 1.11.16 1.53.1.47-.08 1.47-.6 1.68-1.2.2-.58.2-1.08.14-1.18-.06-.1-.21-.16-.45-.3Z"/>
        </svg>
      </a>
    )}

    <button
      id="scroll-to-top"
      type="button"
      class="fixed bottom-24 right-4 z-[69] hidden h-12 w-12 items-center justify-center rounded-full bg-sky-700 text-white shadow-lg transition hover:scale-105 hover:bg-sky-800"
      aria-label="Volver arriba"
      title="Volver arriba"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="m18 15-6-6-6 6" />
      </svg>
    </button>

    <script is:inline>
      (() => {
        const key = "theme";

        document.addEventListener("click", (e) => {
          const btn = e.target?.closest?.("[data-theme-toggle]");
          if (!btn) return;

          const isDark = document.documentElement.classList.toggle("dark");
          document.documentElement.classList.add("h-full");
          localStorage.setItem(key, isDark ? "dark" : "light");
          const favicon = document.getElementById("theme-favicon");
          if (favicon) favicon.setAttribute("href", isDark ? "/favicon-dark.svg" : "/favicon-light.svg");
        });

        const main = document.querySelector("main");
        if (main && !main.id) main.id = "contenido-principal";

        const attachImageFallback = () => {
          const images = Array.from(document.querySelectorAll("img[data-fallback-src]"));
          images.forEach((img) => {
            const fallback = img.getAttribute("data-fallback-src") || "/placeholder.jpg";
            const applyFallback = () => {
              if (img.getAttribute("data-fallback-applied") === "true") return;
              img.setAttribute("data-fallback-applied", "true");
              img.setAttribute("src", fallback);
            };

            const src = (img.getAttribute("src") || "").trim();
            if (!src || src === "undefined" || src === "null") {
              applyFallback();
              return;
            }

            img.addEventListener("error", applyFallback, { once: true });
          });
        };

        attachImageFallback();

        const scrollButton = document.getElementById("scroll-to-top");
        if (scrollButton) {
          const toggleScrollButton = () => {
            const shouldShow = window.scrollY > 320;
            scrollButton.classList.toggle("hidden", !shouldShow);
            scrollButton.classList.toggle("inline-flex", shouldShow);
          };

          window.addEventListener("scroll", toggleScrollButton, { passive: true });
          toggleScrollButton();

          scrollButton.addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
        }
      })();
    </script>
  </body>
</html>
