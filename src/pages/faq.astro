---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getBusinessInfo, getFaqs } from "../lib/sanity.js";

const business = await getBusinessInfo();
const faqs = (await getFaqs()) || [];

const categories = [
  { key: "all", label: "Todas" },
  { key: "podologia", label: "Podología" },
  { key: "psicologia", label: "Psicología" },
  { key: "optica", label: "Óptica" },
  { key: "quiropractica", label: "Quiropráctica" },
  { key: "dentista", label: "Dentista" },
  { key: "general", label: "General" },
];
---

<Layout title={`FAQ | ${business?.name || "Podologos Via Morelos"}`}>
  <Header />

  <main class="mx-auto max-w-6xl px-4 py-10">
    <header class="rounded-3xl border border-sky-100 bg-white p-6 dark:border-slate-800 dark:bg-slate-950">
      <h1 class="type-section-title">Preguntas frecuentes</h1>
      <p class="type-section-subtitle mt-2 text-slate-600 dark:text-slate-300">Resolvemos las dudas más comunes antes de tu cita.</p>

      <div class="mt-5 grid gap-3 md:grid-cols-[1fr_auto] md:items-center">
        <label class="relative block">
          <span class="sr-only">Buscar pregunta</span>
          <input
            id="faq-search"
            type="search"
            placeholder="Buscar por palabra clave..."
            class="w-full rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-slate-800 outline-none ring-sky-300 focus:ring-2 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100"
          />
        </label>

        <div class="flex flex-wrap gap-2" id="faq-filters">
          {categories.map((cat) => (
            <button
              type="button"
              data-filter={cat.key}
              class="rounded-full border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800"
            >
              {cat.label}
            </button>
          ))}
        </div>
      </div>
    </header>

    {faqs.length === 0 ? (
      <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-5 text-sm text-slate-600 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-300">
        Aun no hay preguntas publicadas. Puedes agregarlas en CMS > FAQ.
      </div>
    ) : (
      <section class="mt-6 space-y-3" id="faq-list">
        {faqs.map((item: { _id?: string; question?: string; answer?: string; category?: string; featured?: boolean }) => (
          <article
            class="faq-card overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm transition dark:border-slate-800 dark:bg-slate-950"
            data-faq-card
            data-category={item.category || "general"}
            data-search={`${item.question || ""} ${item.answer || ""}`.toLowerCase()}
          >
            <div class="px-4 py-4 text-left">
              <span class="inline-flex rounded-full bg-sky-100 px-2 py-0.5 text-[11px] font-semibold text-sky-700 dark:bg-sky-900/30 dark:text-sky-300">
                {item.category || "general"}
              </span>
              {item.featured && (
                <span class="ml-2 inline-flex rounded-full bg-emerald-100 px-2 py-0.5 text-[11px] font-semibold text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">
                  Destacada
                </span>
              )}
              <h2 class="type-faq-question mt-2 text-slate-900 dark:text-slate-100">{item.question || "Pregunta"}</h2>
              <p class="type-faq-answer mt-3 text-slate-700 dark:text-slate-300">{item.answer || "Respuesta pendiente."}</p>
            </div>
          </article>
        ))}
      </section>
    )}

    <p id="faq-empty" class="mt-6 hidden rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-600 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-300">
      No encontramos preguntas con ese filtro. Prueba con otra palabra o categoría.
    </p>
  </main>

  <Footer />
</Layout>

<script is:inline>
  const searchInput = document.getElementById("faq-search");
  const filterButtons = Array.from(document.querySelectorAll("[data-filter]"));
  const cards = Array.from(document.querySelectorAll("[data-faq-card]"));
  const emptyState = document.getElementById("faq-empty");
  let activeFilter = "all";

  const categoryLabel = (raw) => {
    const map = {
      podologia: "Podología",
      psicologia: "Psicología",
      optica: "Óptica",
      quiropractica: "Quiropráctica",
      dentista: "Dentista",
      general: "General",
    };
    return map[raw] || "General";
  };

  document.querySelectorAll("[data-faq-card]").forEach((card) => {
    const chip = card.querySelector("span");
    if (chip && card.dataset.category) chip.textContent = categoryLabel(card.dataset.category);
  });

  const updateFiltersUI = () => {
    filterButtons.forEach((btn) => {
      const isActive = btn.dataset.filter === activeFilter;
      btn.classList.toggle("bg-sky-700", isActive);
      btn.classList.toggle("text-white", isActive);
      btn.classList.toggle("border-sky-700", isActive);
    });
  };

  const applyFilters = () => {
    const term = (searchInput?.value || "").trim().toLowerCase();
    let visibleCount = 0;

    cards.forEach((card) => {
      const category = card.dataset.category || "general";
      const haystack = card.dataset.search || "";
      const matchCategory = activeFilter === "all" || category === activeFilter;
      const matchSearch = !term || haystack.includes(term);
      const visible = matchCategory && matchSearch;
      card.classList.toggle("hidden", !visible);
      if (visible) visibleCount += 1;
    });

    if (emptyState) emptyState.classList.toggle("hidden", visibleCount > 0);
  };

  filterButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      activeFilter = btn.dataset.filter || "all";
      updateFiltersUI();
      applyFilters();
    });
  });

  if (searchInput) searchInput.addEventListener("input", applyFilters);

  updateFiltersUI();
  applyFilters();
</script>
