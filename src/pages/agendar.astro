---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { clinic } from "../config/clinic";
import { getBusinessInfo, getPrices, getServices, getSpecialists } from "../lib/sanity.js";
import { getPrefillFromUrl, normalizeServiceSlug } from "../utils/prefill";
import { resolveWhatsAppNumber } from "../utils/whatsapp";

type ServiceItem = {
  title?: string;
  category?: string;
  slug?: string | { current?: string };
};

type Specialist = {
  _id?: string;
  slug?: string;
  name?: string;
  specialty?: string;
  specialtyCategory?: string;
  whatsAppNumber?: string;
  whatsAppMessage?: string;
  active?: boolean;
};

type PriceRow = {
  serviceTitle?: string;
  category?: string;
  priceFrom?: number;
};

const business = await getBusinessInfo();
const services: ServiceItem[] = (await getServices()) || [];
const specialists: Specialist[] = (await getSpecialists()) || [];
const prices: PriceRow[] = (await getPrices()) || [];

const generalWhatsappNumber = resolveWhatsAppNumber(
  business?.whatsappCitasNumber,
  clinic.whatsappNumber
);
const specialistsWhatsappNumber = resolveWhatsAppNumber(
  business?.whatsappSpecialistsNumber,
  generalWhatsappNumber
);
const generalWhatsAppMessage = String(business?.whatsappGeneralMessage || "").trim();
const specialistsWhatsAppMessage = String(business?.whatsappSpecialistsMessage || "").trim();
const quickProblemDefault = String(business?.whatsappQuickProblemDefault || "").trim();
const address = business?.address || clinic.address;
const hoursText = business?.hoursText || "L-V 10:00 a 18:00 · Sabado 10:00 a 16:00 · Domingo cerrado";

const categoryMap = new Map<string, string>();
for (const c of clinic.serviceCategories) categoryMap.set(c.key, c.label);
for (const s of services) {
  const key = normalizeServiceSlug(s?.category || "");
  if (key && !categoryMap.has(key)) categoryMap.set(key, s?.category || key);
}
for (const sp of specialists) {
  const key = normalizeServiceSlug(sp?.specialtyCategory || "");
  if (key && !categoryMap.has(key)) categoryMap.set(key, sp?.specialtyCategory || key);
}

const serviceOptions = Array.from(categoryMap.entries()).map(([key, label]) => ({ key, label }));

const specialistOptions = specialists
  .filter((sp) => Boolean((sp?.slug || sp?._id || "").trim()))
  .map((sp) => ({
    slug: String(sp?.slug || sp?._id || "").trim(),
    name: sp?.name || "Especialista",
    category: normalizeServiceSlug(sp?.specialtyCategory || ""),
    specialty: sp?.specialty || "",
    whatsAppNumber: String(sp?.whatsAppNumber || "").trim(),
    whatsAppMessage: String(sp?.whatsAppMessage || "").trim(),
  }));

const prefill = getPrefillFromUrl(Astro.url);
const quoteSelectionLimit = Math.max(1, Number(clinic.quoteSelectionLimit || 6));
const prefillServices = Array.isArray(prefill.services) ? prefill.services.slice(0, quoteSelectionLimit) : [];
const prefillApproxTotal = typeof prefill.approxTotal === "number" ? prefill.approxTotal : 0;

const priceCatalog = prices.map((item) => ({
  title: item.serviceTitle || "",
  category: normalizeServiceSlug(item.category || ""),
  priceFrom: Number(item.priceFrom || 0),
}));

const validServiceKeys = new Set(serviceOptions.map((option) => option.key));
let resolvedPrefillService = prefill.service || "";
if (!validServiceKeys.has(resolvedPrefillService)) {
  const firstServiceFromList = prefillServices[0] || "";
  const matchedCatalog = priceCatalog.find(
    (row) =>
      row.title &&
      row.category &&
      row.title.toLowerCase().trim() === firstServiceFromList.toLowerCase().trim() &&
      validServiceKeys.has(row.category)
  );
  if (matchedCatalog?.category) resolvedPrefillService = matchedCatalog.category;
}
---

<Layout title="Agendar | Podologo Plus Care">
  <Header />

  <main class="mx-auto max-w-6xl px-4 py-10" id="contenido-principal">
    <h1 class="text-3xl font-bold tracking-tight md:text-4xl">Agenda tu cita</h1>
    <p class="mt-2 text-slate-600 dark:text-slate-300">Completa tus datos. El formulario no guarda informacion, solo genera tu solicitud por WhatsApp.</p>

    <div class="mt-8 grid gap-6 lg:grid-cols-2">
      <section class="rounded-2xl border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-950">
        <h2 class="text-lg font-semibold">Datos de la cita</h2>

        <form id="appointment-form" class="mt-4 grid gap-4" novalidate autocomplete="off">
          <div id="quote-summary" class="rounded-xl border border-sky-200 bg-sky-50 p-3 text-sm dark:border-sky-900/40 dark:bg-sky-950/20">
            <p class="font-semibold text-slate-900 dark:text-slate-100">Resumen de cotizacion</p>
            <p id="context-badge" class="mt-1 hidden text-xs font-semibold text-sky-700 dark:text-sky-300">
              Agendando con especialista
            </p>
            <p id="quote-services" class="mt-1 text-slate-700 dark:text-slate-200">
              {prefillServices.length > 0 ? prefillServices.join(" · ") : "Selecciona un servicio para ver precio aproximado."}
            </p>
            <p id="quote-total" class={`mt-1 text-slate-700 dark:text-slate-200 ${prefillApproxTotal > 0 ? "" : "hidden"}`}>
              <span class="font-semibold">Total aproximado:</span>{" "}
              {new Intl.NumberFormat("es-MX", { style: "currency", currency: "MXN", maximumFractionDigits: 0 }).format(prefillApproxTotal)}
            </p>
          </div>

          <div class="grid gap-2">
            <label class="text-sm font-medium" for="name">Nombre</label>
            <input id="name" name="name" required minlength="2" maxlength="80" autocomplete="name" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-950" placeholder="Tu nombre completo" />
          </div>

          <div class="grid gap-2">
            <label class="text-sm font-medium" for="phone">Telefono</label>
            <input id="phone" name="phone" type="tel" required autocomplete="tel" inputmode="numeric" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-950" placeholder="Ej. 55 2538 8683" />
            <p class="text-xs text-slate-500 dark:text-slate-400">Acepta espacios o guiones. Se valida entre 10 y 15 digitos y evita numeros invalidos (ej. todos iguales).</p>
            <p id="phone-error" class="hidden text-xs font-medium text-rose-600 dark:text-rose-400">Ingresa un telefono valido de 10 a 15 digitos (no se permiten numeros repetidos como 0000000000).</p>
          </div>

          <div class="grid gap-2">
            <label class="text-sm font-medium" for="service">Servicio</label>
            <select id="service" name="service" required class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-950">
              <option value="" selected={!resolvedPrefillService} disabled>Selecciona servicio...</option>
              {serviceOptions.map((s) => (
                <option value={s.key} selected={resolvedPrefillService === s.key}>{s.label}</option>
              ))}
            </select>
          </div>

          <div class="grid gap-2">
            <label class="text-sm font-medium" for="specialist">Especialista (opcional)</label>
            <select id="specialist" name="specialist" disabled class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm disabled:opacity-60 dark:border-slate-800 dark:bg-slate-950">
              <option value="">Sin preferencia (el que este disponible)</option>
            </select>
          </div>

          <div class="grid gap-4 sm:grid-cols-3">
            <div class="grid gap-2 sm:col-span-2">
              <label class="text-sm font-medium" for="date">Fecha (opcional)</label>
              <input
                id="date"
                name="date"
                type="text"
                inputmode="numeric"
                autocomplete="off"
                maxlength="10"
                placeholder="dd/mm/aaaa"
                class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-950"
              />
              <p id="date-readable" class="text-xs text-slate-500 dark:text-slate-400"></p>
              <p id="date-error" class="hidden text-xs font-medium text-rose-600 dark:text-rose-400">Usa formato dd/mm/aaaa (ejemplo 23/02/2026).</p>
            </div>
            <div class="grid gap-2">
              <label class="text-sm font-medium" for="timeSlot">Hora exacta</label>
              <select id="timeSlot" name="timeSlot" disabled class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm disabled:opacity-60 dark:border-slate-800 dark:bg-slate-950">
                <option value="">Selecciona hora</option>
              </select>
              <p id="time-help" class="text-xs text-slate-500 dark:text-slate-400">Si prefieres, deja vacio y usa el turno.</p>
            </div>
          </div>

          <div class="grid gap-2">
            <label class="text-sm font-medium" for="shift">Turno (si no eliges hora)</label>
            <select id="shift" name="shift" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-950">
              <option value="">Por definir</option>
              <option value="Mañana">Mañana</option>
              <option value="Tarde">Tarde</option>
            </select>
          </div>

          <div class="grid gap-2">
            <label class="text-sm font-medium" for="notes">Problema o notas (opcional)</label>
            <textarea id="notes" name="notes" rows="3" maxlength="300" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-950" placeholder="Describe brevemente tu motivo"></textarea>
          </div>

          <a id="send-whatsapp" href="#" target="_blank" rel="noopener noreferrer" class="pointer-events-none rounded-xl bg-slate-400 px-4 py-3 text-center text-sm font-semibold text-white">
            Completa los campos para enviar por WhatsApp
          </a>

          <p class="text-xs text-slate-500 dark:text-slate-400">Validamos horario: L-V 10:00-18:00, Sabado 10:00-16:00, Domingo cerrado.</p>
        </form>
      </section>

      <aside class="rounded-2xl border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-950">
        <h2 class="text-lg font-semibold">Informacion</h2>
        <p class="mt-2 text-slate-700 dark:text-slate-200">{address}</p>
        <p class="mt-3 text-sm text-slate-600 dark:text-slate-300">Horarios: {hoursText}</p>

        <ul class="mt-5 grid gap-2 text-sm text-slate-700 dark:text-slate-300">
          <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-sky-600"></span><span>Confirmacion por WhatsApp.</span></li>
          <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-sky-600"></span><span>Duracion aproximada: 30 a 60 minutos.</span></li>
          <li class="flex items-start gap-2"><span class="mt-1 h-2 w-2 rounded-full bg-sky-600"></span><span>Higiene y protocolos de atencion profesional.</span></li>
        </ul>

        <div class="mt-6">
          <a class="text-sm font-medium text-sky-700 hover:underline dark:text-sky-300" href="/ubicacion">Ver ubicacion</a>
        </div>
      </aside>
    </div>
  </main>

  <Footer />
</Layout>

<script
  id="agendar-config"
  type="application/json"
  is:inline
  set:html={JSON.stringify({
    generalWhatsappNumber,
    specialistsWhatsappNumber,
    generalWhatsAppMessage,
    specialistsWhatsAppMessage,
    quickProblemDefault,
    businessName: business?.name || clinic.name,
    serviceOptions,
    specialistOptions,
    prefill: {
      ...prefill,
      service: resolvedPrefillService || prefill.service,
    },
    quoteSelectionLimit,
    priceCatalog,
  })}
></script>

<script>
  import {
    buildAppointmentMessage,
    buildWhatsAppUrl,
    resolveWhatsAppNumber,
    resolveWhatsAppReason,
  } from "../utils/whatsapp";
  import { formatDateMX, isSunday, isValidPhone, isValidPhoneInput, isWithinSchedule, sanitizePhone } from "../utils/validation";
  import { getPrefillFromUrl } from "../utils/prefill";

  type SpecialistOption = {
    slug: string;
    name: string;
    category: string;
    specialty?: string;
    whatsAppNumber?: string;
    whatsAppMessage?: string;
  };

  type ClientConfig = {
    generalWhatsappNumber?: string;
    specialistsWhatsappNumber?: string;
    generalWhatsAppMessage?: string;
    specialistsWhatsAppMessage?: string;
    quickProblemDefault?: string;
    businessName?: string;
    prefill?: { service?: string; specialist?: string; services?: string[]; approxTotal?: number };
    specialistOptions?: SpecialistOption[];
    quoteSelectionLimit?: number;
    priceCatalog?: Array<{ title: string; category: string; priceFrom: number }>;
  };

  const configEl = document.getElementById("agendar-config");
  const config = JSON.parse(configEl?.textContent || "{}") as ClientConfig;

  const form = document.getElementById("appointment-form") as HTMLFormElement | null;
  const sendBtn = document.getElementById("send-whatsapp") as HTMLAnchorElement | null;
  const nameInput = document.getElementById("name") as HTMLInputElement | null;
  const phoneInput = document.getElementById("phone") as HTMLInputElement | null;
  const serviceSelect = document.getElementById("service") as HTMLSelectElement | null;
  const specialistSelect = document.getElementById("specialist") as HTMLSelectElement | null;
  const dateInput = document.getElementById("date") as HTMLInputElement | null;
  const timeSlotSelect = document.getElementById("timeSlot") as HTMLSelectElement | null;
  const shiftSelect = document.getElementById("shift") as HTMLSelectElement | null;
  const notesInput = document.getElementById("notes") as HTMLTextAreaElement | null;
  const dateReadable = document.getElementById("date-readable") as HTMLParagraphElement | null;
  const dateError = document.getElementById("date-error") as HTMLParagraphElement | null;
  const phoneError = document.getElementById("phone-error") as HTMLParagraphElement | null;
  const timeHelp = document.getElementById("time-help") as HTMLParagraphElement | null;
  const quoteServicesEl = document.getElementById("quote-services") as HTMLParagraphElement | null;
  const quoteTotalEl = document.getElementById("quote-total") as HTMLParagraphElement | null;
  const contextBadgeEl = document.getElementById("context-badge") as HTMLParagraphElement | null;

  if (!form || !sendBtn || !nameInput || !phoneInput || !serviceSelect || !specialistSelect || !dateInput || !timeSlotSelect || !shiftSelect || !notesInput) {
    throw new Error("No se encontraron elementos del formulario de agendar");
  }

  // Refuerzo defensivo: evita que el navegador renderice picker nativo mm/dd/yyyy.
  dateInput.type = "text";
  dateInput.inputMode = "numeric";
  dateInput.autocomplete = "off";
  dateInput.placeholder = "dd/mm/aaaa";

  window.addEventListener("pageshow", (event) => {
    if (event.persisted) {
      window.location.reload();
    }
  });

  const specialistItems: SpecialistOption[] = Array.isArray(config.specialistOptions)
    ? config.specialistOptions
    : [];
  const serverPrefill = config.prefill || {};
  const urlPrefill = getPrefillFromUrl(window.location.href);
  const prefill = {
    ...serverPrefill,
    ...urlPrefill,
    services: Array.isArray(urlPrefill.services) && urlPrefill.services.length > 0
      ? urlPrefill.services
      : (Array.isArray(serverPrefill.services) ? serverPrefill.services : []),
    approxTotal: Number(urlPrefill.approxTotal || serverPrefill.approxTotal || 0),
  };
  const quoteLimit = Math.max(1, Number(config.quoteSelectionLimit || 6));
  let selectedServicesState = Array.isArray(prefill.services) ? prefill.services.slice(0, quoteLimit) : [];
  let quoteTotalState = Number(prefill.approxTotal || 0);
  const priceCatalog = Array.isArray(config.priceCatalog) ? config.priceCatalog : [];
  const generalWaNumber = resolveWhatsAppNumber(config.generalWhatsappNumber);
  const specialistsWaNumber = resolveWhatsAppNumber(
    config.specialistsWhatsappNumber,
    generalWaNumber
  );
  const generalWhatsAppMessage = String(config.generalWhatsAppMessage || "").trim();
  const specialistsWhatsAppMessage = String(config.specialistsWhatsAppMessage || "").trim();
  const quickProblemDefault = String(config.quickProblemDefault || "").trim();
  const businessName = String(config.businessName || "Podologo Plus Care").trim();
  const dateDisplayPattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
  const scheduleByDay: Record<number, { open: string; close: string } | null> = {
    0: null,
    1: { open: "10:00", close: "18:00" },
    2: { open: "10:00", close: "18:00" },
    3: { open: "10:00", close: "18:00" },
    4: { open: "10:00", close: "18:00" },
    5: { open: "10:00", close: "18:00" },
    6: { open: "10:00", close: "16:00" },
  };

  const setFieldErrorStyle = (input: HTMLElement, hasError: boolean) => {
    input.classList.remove("border-emerald-500", "ring-emerald-300", "dark:ring-emerald-500/40");
    input.classList.toggle("border-rose-500", hasError);
    input.classList.toggle("ring-1", hasError);
    input.classList.toggle("ring-rose-300", hasError);
    input.classList.toggle("dark:ring-rose-500/40", hasError);
  };

  const setFieldSuccessStyle = (input: HTMLElement, hasSuccess: boolean) => {
    input.classList.remove("border-rose-500", "ring-rose-300", "dark:ring-rose-500/40");
    input.classList.toggle("border-emerald-500", hasSuccess);
    input.classList.toggle("ring-1", hasSuccess);
    input.classList.toggle("ring-emerald-300", hasSuccess);
    input.classList.toggle("dark:ring-emerald-500/40", hasSuccess);
  };

  const validatePhoneField = () => {
    const hasValue = phoneInput.value.trim().length > 0;
    const valid = isValidPhoneInput(phoneInput.value || "");
    const hasError = hasValue && !valid;
    setFieldErrorStyle(phoneInput, hasError);
    if (phoneError) phoneError.classList.toggle("hidden", !hasError);
    return valid;
  };

  const parseDisplayDateToIso = (displayDate: string) => {
    const value = String(displayDate || "").trim();
    if (!value) return "";

    const match = value.match(dateDisplayPattern);
    if (!match) return "";

    const [, dd, mm, yyyy] = match;
    const day = Number(dd);
    const month = Number(mm);
    const year = Number(yyyy);

    if (!Number.isInteger(day) || !Number.isInteger(month) || !Number.isInteger(year)) return "";
    if (year < 1900 || year > 2100) return "";

    const iso = `${yyyy}-${mm}-${dd}`;
    const date = new Date(`${iso}T12:00:00`);
    if (Number.isNaN(date.getTime())) return "";

    const validDate =
      date.getFullYear() === year &&
      date.getMonth() + 1 === month &&
      date.getDate() === day;

    return validDate ? iso : "";
  };

  const formatDateDigits = (rawValue: string) => {
    const digits = String(rawValue || "").replace(/\D/g, "").slice(0, 8);
    const dd = digits.slice(0, 2);
    const mm = digits.slice(2, 4);
    const yyyy = digits.slice(4, 8);

    if (!digits) return "";

    let formatted = dd;
    if (mm) formatted += `/${mm}`;
    if (yyyy) formatted += `/${yyyy}`;
    return formatted;
  };

  const normalizeDateInputValue = () => {
    dateInput.value = formatDateDigits(dateInput.value);
  };

  const today = new Date();
  const todayIso = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;

  const toMoneyMX = (value: number) =>
    new Intl.NumberFormat("es-MX", { style: "currency", currency: "MXN", maximumFractionDigits: 0 }).format(value || 0);

  const getMinPriceByCategory = (category: string): number => {
    const matches = priceCatalog
      .filter((row) => row.category === category)
      .map((row) => Number(row.priceFrom || 0))
      .filter((value) => value > 0);
    if (matches.length === 0) return 0;
    return Math.min(...matches);
  };

  const getCurrentQuote = () => {
    const selectedLabel = serviceSelect.options[serviceSelect.selectedIndex]?.text || "";
    const selectedCategory = String(serviceSelect.value || "");
    const hasSelectedSpecialist = Boolean(String(specialistSelect.value || "").trim());
    const list = selectedServicesState.length > 0
      ? selectedServicesState
      : (selectedLabel ? [selectedLabel] : []);

    let total = Number.isFinite(quoteTotalState) && quoteTotalState > 0 ? quoteTotalState : 0;
    if (total <= 0 && selectedCategory && !hasSelectedSpecialist) {
      total = getMinPriceByCategory(selectedCategory);
    }

    return { list, total };
  };

  const updateQuoteSummary = () => {
    const { list, total } = getCurrentQuote();
    const selectedServiceLabel = serviceSelect.options[serviceSelect.selectedIndex]?.text || "";
    const selectedServiceKey = String(serviceSelect.value || "").trim();
    const specialistSlug = String(specialistSelect.value || "").trim();
    const selectedSpecialist = specialistSlug
      ? specialistItems.find((sp: SpecialistOption) => sp.slug === specialistSlug)
      : undefined;
    const autoSpecialist = selectedSpecialist ? undefined : getAutoSpecialistForService(selectedServiceKey);
    const routingSpecialist = selectedSpecialist || autoSpecialist;

    if (contextBadgeEl) {
      if (routingSpecialist) {
        contextBadgeEl.classList.remove("hidden");
        contextBadgeEl.textContent = selectedSpecialist
          ? `Agendando con especialista: ${routingSpecialist.name || "Especialista"}`
          : `Agendando con especialista de ${selectedServiceLabel || "servicio"}: ${routingSpecialist.name || "Especialista"}`;
      } else if (selectedServiceLabel) {
        contextBadgeEl.classList.remove("hidden");
        contextBadgeEl.textContent = `Agendando servicio: ${selectedServiceLabel}`;
      } else {
        contextBadgeEl.classList.add("hidden");
      }
    }

    if (quoteServicesEl) {
      quoteServicesEl.textContent = list.length > 0
        ? list.join(" · ")
        : "Selecciona un servicio para ver precio aproximado.";
    }

    if (quoteTotalEl) {
      if (total > 0) {
        quoteTotalEl.classList.remove("hidden");
        quoteTotalEl.innerHTML = `<span class="font-semibold">Total aproximado:</span> ${toMoneyMX(total)}`;
      } else {
        quoteTotalEl.classList.add("hidden");
      }
    }
  };

  const buildTimeSlots = (open: string, close: string): string[] => {
    const [openH, openM] = open.split(":").map((x) => Number(x));
    const [closeH, closeM] = close.split(":").map((x) => Number(x));
    const start = openH * 60 + openM;
    const end = closeH * 60 + closeM;
    const slots: string[] = [];
    for (let minutes = start; minutes <= end; minutes += 30) {
      const h = String(Math.floor(minutes / 60)).padStart(2, "0");
      const m = String(minutes % 60).padStart(2, "0");
      slots.push(`${h}:${m}`);
    }
    return slots;
  };

  const updateTimeLimitsByDate = () => {
    const previousValue = timeSlotSelect.value;
    const isoDate = parseDisplayDateToIso(dateInput.value);
    timeSlotSelect.innerHTML = "";
    const baseOption = document.createElement("option");
    baseOption.value = "";
    baseOption.textContent = "Selecciona hora";
    timeSlotSelect.appendChild(baseOption);

    if (!dateInput.value) {
      timeSlotSelect.disabled = true;
      if (timeHelp) {
        timeHelp.textContent = "Si prefieres, deja vacio y usa el turno.";
        timeHelp.classList.remove("text-rose-600", "dark:text-rose-400");
        timeHelp.classList.add("text-slate-500", "dark:text-slate-400");
      }
      return;
    }

    if (!isoDate) {
      timeSlotSelect.disabled = true;
      if (timeHelp) {
        timeHelp.textContent = "Usa formato de fecha dd/mm/aaaa para habilitar horarios.";
        timeHelp.classList.remove("text-slate-500", "dark:text-slate-400");
        timeHelp.classList.add("text-rose-600", "dark:text-rose-400");
      }
      return;
    }

    const date = new Date(`${isoDate}T12:00:00`);
    const day = date.getDay();
    const schedule = scheduleByDay[day];

    if (!schedule) {
      timeSlotSelect.disabled = true;
      if (timeHelp) {
        timeHelp.textContent = "Domingo cerrado. Selecciona otro dia.";
        timeHelp.classList.remove("text-slate-500", "dark:text-slate-400");
        timeHelp.classList.add("text-rose-600", "dark:text-rose-400");
      }
      return;
    }

    const slots = buildTimeSlots(schedule.open, schedule.close);
    slots.forEach((slot) => {
      const option = document.createElement("option");
      option.value = slot;
      option.textContent = slot;
      timeSlotSelect.appendChild(option);
    });
    timeSlotSelect.disabled = false;

    if (slots.includes(previousValue)) {
      timeSlotSelect.value = previousValue;
    } else {
      timeSlotSelect.value = "";
    }

    if (timeHelp) {
      timeHelp.textContent = `Horario disponible: ${schedule.open} a ${schedule.close}.`;
      timeHelp.classList.remove("text-rose-600", "dark:text-rose-400");
      timeHelp.classList.add("text-slate-500", "dark:text-slate-400");
    }
  };

  const renderSpecialists = (serviceKey: string, preferredSpecialist: string = "") => {
    const filtered = specialistItems.filter((sp: SpecialistOption) => sp.category === serviceKey);
    specialistSelect.innerHTML = "";

    const baseOption = document.createElement("option");
    baseOption.value = "";
    baseOption.textContent = "Sin preferencia (el que este disponible)";
    specialistSelect.appendChild(baseOption);

    filtered.forEach((sp: SpecialistOption) => {
      const opt = document.createElement("option");
      opt.value = sp.slug;
      opt.textContent = sp.name;
      specialistSelect.appendChild(opt);
    });

    specialistSelect.disabled = !serviceKey;
    if (preferredSpecialist && filtered.some((sp: SpecialistOption) => sp.slug === preferredSpecialist)) {
      specialistSelect.value = preferredSpecialist;
    } else {
      specialistSelect.value = "";
    }
  };

  const getAutoSpecialistForService = (serviceKey: string): SpecialistOption | undefined => {
    if (!serviceKey) return undefined;
    return specialistItems.find((sp: SpecialistOption) => sp.category === serviceKey);
  };

  const applyPrefill = () => {
    let serviceValue = "";
    if (prefill.service) {
      const matchService = Array.from(serviceSelect.options).find(
        (opt: HTMLOptionElement) => opt.value === prefill.service
      );
      if (matchService) serviceValue = prefill.service;
    }

    if (!serviceValue && selectedServicesState.length > 0) {
      const firstSelected = String(selectedServicesState[0] || "").toLowerCase().trim();
      const fromCatalog = priceCatalog.find((row) => {
        const title = String(row.title || "").toLowerCase().trim();
        const category = String(row.category || "").trim();
        return Boolean(title) && Boolean(category) && title === firstSelected;
      });
      if (fromCatalog?.category) {
        const existsInSelect = Array.from(serviceSelect.options).some(
          (opt: HTMLOptionElement) => opt.value === fromCatalog.category
        );
        if (existsInSelect) serviceValue = fromCatalog.category;
      }
    }

    if (!serviceValue && prefill.specialist) {
      const specialistMatch = specialistItems.find((sp: SpecialistOption) => sp.slug === prefill.specialist);
      if (specialistMatch?.category) serviceValue = specialistMatch.category;
    }

    if (serviceValue) {
      serviceSelect.value = serviceValue;
    }

    renderSpecialists(serviceSelect.value, prefill.specialist);
  };

  const updateDatePreview = () => {
    if (!dateReadable) return;
    const isoDate = parseDisplayDateToIso(dateInput.value);
    if (!dateInput.value) {
      dateReadable.textContent = "Si no eliges fecha, se enviara como por definir.";
      dateReadable.classList.remove("text-emerald-600", "dark:text-emerald-400", "text-rose-600", "dark:text-rose-400");
      dateReadable.classList.add("text-slate-500", "dark:text-slate-400");
      return;
    }

    if (isoDate) {
      dateReadable.textContent = `Fecha seleccionada: ${formatDateMX(isoDate)}`;
      dateReadable.classList.remove("text-slate-500", "dark:text-slate-400", "text-rose-600", "dark:text-rose-400");
      dateReadable.classList.add("text-emerald-600", "dark:text-emerald-400");
      return;
    }

    dateReadable.textContent = "Formato esperado: dd/mm/aaaa.";
    dateReadable.classList.remove("text-slate-500", "dark:text-slate-400", "text-emerald-600", "dark:text-emerald-400");
    dateReadable.classList.add("text-rose-600", "dark:text-rose-400");
  };

  const validateSchedule = () => {
    const isoDate = parseDisplayDateToIso(dateInput.value);
    dateInput.setCustomValidity("");
    timeSlotSelect.setCustomValidity("");
    setFieldErrorStyle(dateInput, false);
    setFieldSuccessStyle(dateInput, false);
    setFieldErrorStyle(timeSlotSelect, false);
    const selectedTime = timeSlotSelect.value;

    if (dateError) dateError.classList.add("hidden");

    if (dateInput.value && !isoDate) {
      dateInput.setCustomValidity("Usa formato dd/mm/aaaa.");
      setFieldErrorStyle(dateInput, true);
      if (dateError) dateError.classList.remove("hidden");
      return false;
    }

    if (isoDate && isoDate < todayIso) {
      dateInput.setCustomValidity("No puedes elegir una fecha pasada.");
      setFieldErrorStyle(dateInput, true);
      if (dateError) {
        dateError.textContent = "No puedes elegir una fecha pasada.";
        dateError.classList.remove("hidden");
      }
      return false;
    }

    if (isoDate && isSunday(isoDate)) {
      dateInput.setCustomValidity("Los domingos no hay atencion.");
      setFieldErrorStyle(dateInput, true);
      if (dateError) {
        dateError.textContent = "Domingo cerrado. Elige otro dia.";
        dateError.classList.remove("hidden");
      }
      return false;
    }

    if (isoDate) {
      setFieldSuccessStyle(dateInput, true);
    }

    if (selectedTime && !isoDate) {
      dateInput.setCustomValidity("Selecciona fecha para validar la hora.");
      setFieldErrorStyle(dateInput, true);
      if (dateError) {
        dateError.textContent = "Selecciona una fecha valida para usar hora exacta.";
        dateError.classList.remove("hidden");
      }
      return false;
    }

    if (isoDate && selectedTime && !isWithinSchedule(isoDate, selectedTime)) {
      timeSlotSelect.setCustomValidity("La hora esta fuera de horario para ese dia.");
      setFieldErrorStyle(timeSlotSelect, true);
      return false;
    }

    if (dateError) {
      dateError.textContent = "Usa formato dd/mm/aaaa (ejemplo 23/02/2026).";
      dateError.classList.add("hidden");
    }

    return true;
  };

  const setDisabledCta = (text: string) => {
    sendBtn.classList.add("pointer-events-none", "bg-slate-400", "hover:bg-slate-400");
    sendBtn.classList.remove("bg-sky-700", "hover:bg-sky-800");
    sendBtn.textContent = text;
    sendBtn.setAttribute("href", "#");
  };

  const setEnabledCta = (href: string) => {
    sendBtn.classList.remove("pointer-events-none", "bg-slate-400", "hover:bg-slate-400");
    sendBtn.classList.add("bg-sky-700", "hover:bg-sky-800");
    sendBtn.textContent = "Enviar solicitud por WhatsApp";
    sendBtn.setAttribute("href", href);
  };

  const updateCta = () => {
    validatePhoneField();
    updateTimeLimitsByDate();
    updateDatePreview();

    if (!validateSchedule()) {
      setDisabledCta("Completa los campos para enviar por WhatsApp");
      return;
    }

    const name = String(nameInput.value || "").trim();
    const phone = sanitizePhone(String(phoneInput.value || ""));
    const service = String(serviceSelect.value || "").trim();

    if (!name || !service || !isValidPhoneInput(phoneInput.value || "") || !isValidPhone(phone)) {
      setDisabledCta("Completa los campos para enviar por WhatsApp");
      return;
    }

    const specialistValue = String(specialistSelect.value || "").trim();
    const selectedSpecialist = specialistValue
      ? specialistItems.find((sp: SpecialistOption) => sp.slug === specialistValue)
      : undefined;
    const autoSpecialist = selectedSpecialist ? undefined : getAutoSpecialistForService(service);
    const routingSpecialist = selectedSpecialist || autoSpecialist;
    const specialistName = routingSpecialist?.name || "Sin preferencia";
    const targetWaNumber = routingSpecialist
      ? resolveWhatsAppNumber(
          routingSpecialist?.whatsAppNumber,
          specialistsWaNumber,
          generalWaNumber
        )
      : generalWaNumber;

    if (!targetWaNumber) {
      setDisabledCta("WhatsApp no configurado");
      return;
    }

    const selectedServiceLabel = serviceSelect.options[serviceSelect.selectedIndex]?.text || service;
    const notesValue = String(notesInput.value || "").trim();
    const problemValue = notesValue || quickProblemDefault || "Por definir";
    const introTemplate = routingSpecialist
      ? (routingSpecialist?.whatsAppMessage || specialistsWhatsAppMessage || generalWhatsAppMessage)
      : generalWhatsAppMessage;
    const introMessage = resolveWhatsAppReason(
      introTemplate,
      routingSpecialist
        ? "Hola, quiero agendar con {especialista} en {negocio}."
        : "Hola, quiero agendar una cita en {negocio}.",
      {
        specialist: specialistName,
        service: selectedServiceLabel,
        business: businessName,
        problem: problemValue,
      }
    );
    const quote = getCurrentQuote();

    const message = buildAppointmentMessage({
      introMessage,
      name,
      phone,
      service: selectedServiceLabel,
      selectedServices: quote.list,
      approxTotal: quote.total > 0 ? quote.total : undefined,
      specialist: specialistName,
      date: parseDisplayDateToIso(dateInput.value) || undefined,
      time: timeSlotSelect.value || undefined,
      shift: String(shiftSelect.value || "") || undefined,
      notes: notesValue || undefined,
    });

    const href = buildWhatsAppUrl(message, targetWaNumber);
    setEnabledCta(href);
  };

  form.reset();
  applyPrefill();
  updateTimeLimitsByDate();
  updateDatePreview();
  updateQuoteSummary();
  updateCta();

  serviceSelect.addEventListener("change", () => {
    const selectedLabel = serviceSelect.options[serviceSelect.selectedIndex]?.text || "";
    selectedServicesState = selectedLabel ? [selectedLabel] : [];
    quoteTotalState = 0;
    renderSpecialists(serviceSelect.value, "");
    updateQuoteSummary();
    updateCta();
  });

  specialistSelect.addEventListener("change", () => {
    updateQuoteSummary();
    updateCta();
  });

  [nameInput, phoneInput, specialistSelect, timeSlotSelect, shiftSelect, notesInput].forEach((el) => {
    if (!el) return;
    el.addEventListener("input", updateCta);
    el.addEventListener("change", updateCta);
  });

  const allowedDateControlKeys = new Set([
    "Backspace",
    "Delete",
    "Tab",
    "Escape",
    "Enter",
    "ArrowLeft",
    "ArrowRight",
    "ArrowUp",
    "ArrowDown",
    "Home",
    "End",
  ]);

  dateInput.addEventListener("keydown", (event) => {
    if (event.ctrlKey || event.metaKey || event.altKey) return;
    if (allowedDateControlKeys.has(event.key)) return;
    if (/^\d$/.test(event.key)) return;
    if (event.key === "/") return;
    event.preventDefault();
  });

  dateInput.addEventListener("beforeinput", (event) => {
    const inputEvent = event as InputEvent;
    if (!inputEvent.data) return;
    if (!inputEvent.inputType || !inputEvent.inputType.startsWith("insert")) return;
    if (/^[\d/]+$/.test(inputEvent.data)) return;
    event.preventDefault();
  });

  dateInput.addEventListener("paste", (event) => {
    event.preventDefault();
    const pasted = event.clipboardData?.getData("text") || "";
    dateInput.value = formatDateDigits(pasted);
    updateCta();
  });

  dateInput.addEventListener("input", () => {
    normalizeDateInputValue();
    updateCta();
  });

  dateInput.addEventListener("change", () => {
    normalizeDateInputValue();
    updateTimeLimitsByDate();
    updateCta();
  });

  shiftSelect.addEventListener("change", () => {
    if (shiftSelect.value && timeSlotSelect.value) {
      timeSlotSelect.value = "";
    }
    updateCta();
  });

  sendBtn.addEventListener("click", (event) => {
    if (sendBtn.getAttribute("href") === "#") {
      event.preventDefault();
      form.reportValidity();
    }
  });
</script>
