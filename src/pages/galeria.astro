---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import VideoEmbed from "../components/VideoEmbed.astro";
import { getGallery } from "../lib/sanity.js";

type GalleryItem = {
  _id?: string;
  title: string;
  category: string;
  type: "image" | "video";
  imageUrl?: string;
  platform?: "youtube" | "tiktok" | "facebook";
  url?: string;
  linkOnly?: boolean;
  linkText?: string;
  linkPreviewImageUrl?: string;
};

const itemsRaw = (await getGallery()) || [];

const items: GalleryItem[] = itemsRaw.map((it: Partial<GalleryItem>, idx: number) => ({
  ...it,
  _id: it._id || `item-${idx}`,
  category: (it.category || "otros").toLowerCase(),
  type: (it.type || (it.imageUrl ? "image" : "video")) as "image" | "video",
  title: it.title || "Sin titulo",
}));

const images = items.filter((it) => it.type === "image");
const videos = items.filter((it) => it.type === "video");
const youtubeVideos = videos.filter((it) => it.platform === "youtube");
const tiktokVideos = videos.filter((it) => it.platform === "tiktok");
const facebookVideos = videos.filter((it) => it.platform === "facebook");

const categoryLabel: Record<string, string> = {
  podologia: "Podologia",
  psicologia: "Psicologia",
  optica: "Optica",
  quiropractica: "Quiropractica",
  dentista: "Dentista",
  instalaciones: "Instalaciones",
  otros: "Otros",
};
---

<Layout title="Galeria | Podologos Via Morelos Tulpetlac">
  <Header />

  <main class="mx-auto max-w-6xl px-4 py-10">
    <h1 class="text-3xl font-bold tracking-tight md:text-4xl">Galeria</h1>
    <p class="mt-2 text-slate-600 dark:text-slate-300">
      Fotos y videos de nuestros servicios e instalaciones.
    </p>

    <div class="mt-6">
      <div class="flex flex-wrap gap-2" data-media-filters>
        <button type="button" data-media-filter="all" class="rounded-full border border-sky-200 bg-sky-600 px-3 py-1 text-sm font-semibold text-white dark:border-sky-700">Todo</button>
        <button type="button" data-media-filter="image" class="rounded-full border border-slate-200 px-3 py-1 text-sm hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-900">Fotos</button>
        <button type="button" data-media-filter="youtube" class="rounded-full border border-slate-200 px-3 py-1 text-sm hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-900">YouTube</button>
        <button type="button" data-media-filter="tiktok" class="rounded-full border border-slate-200 px-3 py-1 text-sm hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-900">TikTok</button>
        <button type="button" data-media-filter="facebook" class="rounded-full border border-slate-200 px-3 py-1 text-sm hover:bg-slate-50 dark:border-slate-800 dark:hover:bg-slate-900">Facebook</button>
      </div>
    </div>

    {items.length === 0 && (
      <div class="mt-8 rounded-2xl border border-slate-200 p-6 text-slate-600 dark:border-slate-800 dark:text-slate-300">
        Pronto compartiremos mas fotos y videos. Mientras tanto, puedes agendar tu cita.
      </div>
    )}

    <section id="imagenes" class="mt-10" data-media-section="image">
      <h2 class="text-xl font-semibold">Fotos</h2>
      {images.length === 0 ? (
        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">Pronto compartiremos fotos en esta seccion.</p>
      ) : (
        <div class="mt-5 grid gap-6 sm:grid-cols-2 lg:grid-cols-3" data-section-grid>
          {images.map((it) => (
            <article data-gallery-item data-media-type="image" class="overflow-hidden rounded-3xl border border-slate-200 dark:border-slate-800">
              <div class="p-4">
                <p class="text-sm font-semibold">{it.title}</p>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                  {categoryLabel[it.category] || it.category}
                </p>
              </div>
              {it.imageUrl ? (
                <img class="aspect-[4/3] w-full object-cover" src={it.imageUrl} alt={it.title} loading="lazy" data-fallback-src="/placeholder.jpg" />
              ) : (
                <div class="flex aspect-[4/3] items-center justify-center bg-slate-100 text-sm text-slate-500 dark:bg-slate-900 dark:text-slate-400">
                  Sin imagen
                </div>
              )}
            </article>
          ))}
        </div>
      )}
    </section>

    <section id="youtube" class="mt-12" data-media-section="youtube">
      <h2 class="text-xl font-semibold">Videos en YouTube</h2>
      {youtubeVideos.length === 0 ? (
        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">Pronto compartiremos videos en YouTube.</p>
      ) : (
        <div class="mt-5 grid gap-6 sm:grid-cols-2 lg:grid-cols-3" data-section-grid>
          {youtubeVideos.map((it) => (
            <article data-gallery-item data-media-type="youtube" class="self-start overflow-hidden rounded-3xl border border-slate-200 dark:border-slate-800">
              <div class="p-4">
                <p class="text-sm font-semibold">{it.title}</p>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                  {categoryLabel[it.category] || it.category}
                </p>
              </div>
              <div class="px-4 pb-4">
                <VideoEmbed
                  platform={it.platform}
                  url={it.url}
                  title={it.title}
                  linkOnly={it.linkOnly}
                  linkText={it.linkText}
                  previewImage={it.linkPreviewImageUrl}
                />
              </div>
            </article>
          ))}
        </div>
      )}
    </section>

    <section id="tiktok" class="mt-12" data-media-section="tiktok">
      <h2 class="text-xl font-semibold">Videos en TikTok</h2>
      {tiktokVideos.length === 0 ? (
        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">Pronto compartiremos videos en TikTok.</p>
      ) : (
        <div class="mt-5 grid gap-6 sm:grid-cols-2 lg:grid-cols-3" data-section-grid>
          {tiktokVideos.map((it) => (
            <article data-gallery-item data-media-type="tiktok" class="self-start overflow-hidden rounded-3xl border border-slate-200 dark:border-slate-800">
              <div class="p-4">
                <p class="text-sm font-semibold">{it.title}</p>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                  {categoryLabel[it.category] || it.category}
                </p>
              </div>
              <div class="px-4 pb-4">
                <VideoEmbed
                  platform={it.platform}
                  url={it.url}
                  title={it.title}
                  linkOnly={it.linkOnly}
                  linkText={it.linkText}
                  previewImage={it.linkPreviewImageUrl}
                />
              </div>
            </article>
          ))}
        </div>
      )}
    </section>

    <section id="facebook" class="mt-12" data-media-section="facebook">
      <h2 class="text-xl font-semibold">Videos en Facebook</h2>
      {facebookVideos.length === 0 ? (
        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">Pronto compartiremos videos en Facebook.</p>
      ) : (
        <div class="mt-5 grid gap-6 sm:grid-cols-2 lg:grid-cols-3" data-section-grid>
          {facebookVideos.map((it) => (
            <article data-gallery-item data-media-type="facebook" class="self-start overflow-hidden rounded-3xl border border-slate-200 dark:border-slate-800">
              <div class="p-4">
                <p class="text-sm font-semibold">{it.title}</p>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                  {categoryLabel[it.category] || it.category}
                </p>
              </div>
              <div class="px-4 pb-4">
                <VideoEmbed
                  platform={it.platform}
                  url={it.url}
                  title={it.title}
                  linkOnly={it.linkOnly}
                  linkText={it.linkText}
                  previewImage={it.linkPreviewImageUrl}
                />
              </div>
            </article>
          ))}
        </div>
      )}
    </section>
  </main>

  <Footer />
</Layout>

<script is:inline>
  (() => {
    const mediaButtons = Array.from(document.querySelectorAll("[data-media-filter]"));
    const items = Array.from(document.querySelectorAll("[data-gallery-item]"));
    const sections = Array.from(document.querySelectorAll("[data-media-section]"));

    if (!mediaButtons.length || !sections.length) return;

    let activeMedia = "all";

    const setActiveStyle = (buttons, activeValue, attrName) => {
      buttons.forEach((button) => {
        const isActive = button.getAttribute(attrName) === activeValue;
        button.classList.toggle("bg-sky-600", isActive);
        button.classList.toggle("text-white", isActive);
        button.classList.toggle("border-sky-200", isActive);
        button.classList.toggle("dark:border-sky-700", isActive);
        button.classList.toggle("font-semibold", isActive);
      });
    };

    const applyFilters = () => {
      items.forEach((item) => {
        const mediaType = item.getAttribute("data-media-type") || "";
        const show = activeMedia === "all" || mediaType === activeMedia;
        item.classList.toggle("hidden", !show);
      });

      sections.forEach((section) => {
        const sectionMedia = section.getAttribute("data-media-section") || "";
        const mediaSectionOk = activeMedia === "all" || sectionMedia === activeMedia;
        section.classList.toggle("hidden", !mediaSectionOk);
      });
    };

    mediaButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const value = button.getAttribute("data-media-filter") || "all";
        activeMedia = value;
        setActiveStyle(mediaButtons, activeMedia, "data-media-filter");
        applyFilters();

        const targetId = value === "all" ? "imagenes" : value;
        const target = document.getElementById(targetId);
        if (target) {
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });

    setActiveStyle(mediaButtons, activeMedia, "data-media-filter");
    applyFilters();
  })();
</script>
