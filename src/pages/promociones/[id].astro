---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getPromotionByPath, getPromotions } from "../../lib/sanity.js";
import { normalizeServiceSlug } from "../../utils/prefill";

type Promotion = {
  _id: string;
  title: string;
  label?: string;
  shortDescription?: string;
  description?: string;
  startDate?: string;
  endDate?: string;
  featured?: boolean;
  pinned?: boolean;
  targetCategories?: string[];
  appliesTo?: string[];
  serviceCategories?: string[];
  slug?: string;
  imageUrl?: string;
};

export async function getStaticPaths() {
  const promos: Promotion[] = (await getPromotions()) || [];
  return promos.map((promo: Promotion) => ({
    params: { id: promo?.slug || promo?._id },
  }));
}

const { id } = Astro.params;
const promo = id ? await getPromotionByPath(id) : null;

if (!promo) {
  return Astro.redirect("/promociones");
}

function fmt(d: string | Date | null | undefined) {
  if (!d) return "";
  try {
    return new Date(d).toLocaleDateString("es-MX", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });
  } catch {
    return String(d);
  }
}

function promotionValidityText(startDate?: string, endDate?: string) {
  const hasStart = Boolean(startDate);
  const hasEnd = Boolean(endDate);
  if (!hasStart && !hasEnd) return "";
  if (hasStart && hasEnd) return `Vigencia: ${fmt(startDate)} a ${fmt(endDate)}`;
  if (hasStart) return `Vigencia desde: ${fmt(startDate)}`;
  return `Vigencia hasta: ${fmt(endDate)}`;
}

const promoServiceParam = normalizeServiceSlug(
  (promo?.targetCategories || [])[0] ||
    (promo?.appliesTo || [])[0] ||
    (promo?.serviceCategories || [])[0] ||
    ""
);
const promoAgendarHref = (() => {
  const params = new URLSearchParams();
  if (promoServiceParam) params.set("service", promoServiceParam);
  if (promo?.title) params.append("services", promo.title);
  const qs = params.toString();
  return qs ? `/agendar?${qs}` : "/agendar";
})();
---

<Layout title={`${promo.title} | Promociones`} description={promo.shortDescription || promo.description || "Detalle de promocion"}>
  <Header />

  <main class="mx-auto max-w-4xl px-4 py-10">
    <a href="/promociones" class="text-sm font-semibold text-sky-700 hover:underline dark:text-sky-300">Volver a promociones</a>

    <article class="mt-4 overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm dark:border-slate-800 dark:bg-slate-950">
      {promo.imageUrl ? (
        <div class="flex w-full items-center justify-center bg-slate-50 p-4 dark:bg-slate-900 md:p-6">
          <img src={promo.imageUrl} alt={promo.title} class="max-h-[42rem] w-auto max-w-full object-contain" loading="eager" data-fallback-src="/placeholder.jpg" />
        </div>
      ) : (
        <div class="flex h-72 items-center justify-center bg-slate-100 text-sm text-slate-500 dark:bg-slate-900 dark:text-slate-400">
          Sin imagen de promocion
        </div>
      )}

      <div class="p-6 md:p-8">
        <div class="flex flex-wrap items-center gap-2">
          {promo.label && <span class="rounded-full bg-sky-100 px-3 py-1 text-xs font-semibold text-sky-700 dark:bg-sky-900/40 dark:text-sky-300">{promo.label}</span>}
          {promo.featured && <span class="rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300">Recomendada</span>}
        </div>

        <h1 class="mt-3 text-3xl font-bold tracking-tight md:text-4xl">{promo.title}</h1>
        {promo.shortDescription && <p class="mt-3 text-lg text-slate-700 dark:text-slate-300">{promo.shortDescription}</p>}
        {promo.description && <p class="mt-4 whitespace-pre-line text-slate-700 dark:text-slate-300">{promo.description}</p>}

        {promotionValidityText(promo.startDate, promo.endDate) && (
          <p class="mt-6 text-sm text-slate-600 dark:text-slate-400">
            {promotionValidityText(promo.startDate, promo.endDate)}
          </p>
        )}

        {Array.isArray(promo.appliesTo) && promo.appliesTo.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {promo.appliesTo.map((tag: string) => (
              <span class="rounded-full border border-slate-200 px-3 py-1 text-xs dark:border-slate-700">{tag}</span>
            ))}
          </div>
        )}

        <div class="mt-8 flex flex-wrap gap-3">
          <a href={promoAgendarHref} class="btn-base btn-primary">Agendar con esta promocion</a>
          <a href="/contacto" class="btn-base btn-secondary">Resolver dudas</a>
        </div>
      </div>
    </article>
  </main>

  <Footer />
</Layout>
