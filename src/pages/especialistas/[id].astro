---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { clinic } from "../../config/clinic";
import { getBusinessInfo, getSpecialistByPath, getSpecialists } from "../../lib/sanity.js";
import { normalizeServiceSlug } from "../../utils/prefill";
import { buildContactMessage, buildWhatsAppUrl } from "../../utils/whatsapp";

type Specialist = {
  _id?: string;
  slug?: string;
  name?: string;
  specialty?: string;
  specialtyCategory?: string;
  shortBio?: string;
  focusAreas?: string[];
  whatsAppMessage?: string;
  photoUrl?: string;
};

export async function getStaticPaths() {
  const specialists: Specialist[] = (await getSpecialists()) || [];
  return specialists.map((specialist: Specialist) => ({
    params: { id: specialist?.slug || specialist?._id },
  }));
}

const { id } = Astro.params;
const specialist: Specialist | null = id ? await getSpecialistByPath(id) : null;
const business = await getBusinessInfo();

if (!specialist) {
  return Astro.redirect("/especialistas");
}

const waNumber = String(business?.whatsappCitasNumber || clinic.whatsappNumber).replace(/\D/g, "");
const waLink = waNumber
  ? buildWhatsAppUrl(
      buildContactMessage({
        service: specialist?.specialty || "Especialista",
        reason: specialist?.whatsAppMessage?.trim() || `Quiero agendar con ${specialist?.name || "este especialista"}.`,
      }),
      waNumber
    )
  : "/agendar";
const serviceParam = normalizeServiceSlug(specialist?.specialtyCategory || specialist?.specialty || "");
const specialistParam = (specialist?.slug || specialist?._id || "").trim();
const prefilledAgendarHref = (() => {
  const params = new URLSearchParams();
  if (serviceParam) params.set("service", serviceParam);
  if (specialistParam) params.set("specialist", specialistParam);
  if (specialist?.specialty) params.append("services", specialist.specialty);
  const qs = params.toString();
  return qs ? `/agendar?${qs}` : "/agendar";
})();
---

<Layout title={`${specialist.name || "Especialista"} | Especialistas`} description={specialist.shortBio || specialist.specialty || "Perfil de especialista"}>
  <Header />

  <main class="mx-auto max-w-5xl px-4 py-10">
    <a href="/especialistas" class="text-sm font-semibold text-sky-700 hover:underline dark:text-sky-300">Volver a especialistas</a>

    <section class="mt-4 grid gap-8 rounded-3xl border border-slate-200 bg-white p-6 md:grid-cols-[0.9fr,1.1fr] md:p-8 dark:border-slate-800 dark:bg-slate-950">
      <div>
        <img
          class="h-80 w-full rounded-2xl object-cover md:h-full"
          src={specialist.photoUrl || "https://images.unsplash.com/photo-1559839734-2b71ea197ec2?auto=format&fit=crop&w=1000&q=80"}
          alt={specialist.name || "Especialista"}
          loading="eager"
          data-fallback-src="/placeholder.jpg"
        />
      </div>

      <div>
        <h1 class="text-3xl font-bold tracking-tight">{specialist.name || "Especialista"}</h1>
        <p class="mt-2 text-lg font-semibold text-sky-700 dark:text-sky-300">{specialist.specialty || "Especialidad"}</p>
        <p class="mt-4 whitespace-pre-line text-slate-700 dark:text-slate-300">{specialist.shortBio || "Perfil disponible pronto."}</p>

        {Array.isArray(specialist.focusAreas) && specialist.focusAreas.length > 0 && (
          <div class="mt-6">
            <h2 class="text-sm font-semibold uppercase tracking-[0.15em] text-slate-500 dark:text-slate-400">Areas de atencion</h2>
            <div class="mt-3 flex flex-wrap gap-2">
              {specialist.focusAreas.map((area: string) => (
                <span class="rounded-full border border-slate-200 px-3 py-1 text-sm dark:border-slate-700">{area}</span>
              ))}
            </div>
          </div>
        )}

        <div class="mt-8 flex flex-wrap gap-3">
          <a href={waLink} target={waNumber ? "_blank" : undefined} rel={waNumber ? "noopener noreferrer" : undefined} class="btn-base btn-primary">
            WhatsApp con este especialista
          </a>
          <a href={prefilledAgendarHref} class="btn-base btn-secondary">
            Agendar con este especialista
          </a>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>
