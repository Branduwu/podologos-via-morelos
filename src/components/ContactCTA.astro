---
import { clinic } from "../config/clinic";
import {
  buildContactMessage,
  buildWhatsAppUrl,
  resolveWhatsAppNumber,
  resolveWhatsAppReason,
} from "../utils/whatsapp";
import { safeCmsUrl } from "../utils/url";

type Props = {
  business?: {
    name?: string;
    address?: string;
    phone?: string;
    whatsappCitasNumber?: string;
    whatsappGeneralMessage?: string;
    whatsappQuickProblemDefault?: string;
    mapsUrl?: string;
    facebookUrl?: string;
    instagramUrl?: string;
    tiktokUrl?: string;
  } | null;
};

const { business } = Astro.props as Props;
const address = business?.address || clinic.address;
const phoneDisplay = business?.phone || clinic.phoneDisplay;
const phoneTel = String(phoneDisplay).replace(/\D/g, "") || clinic.phoneTel;
const waNumber = resolveWhatsAppNumber(
  business?.whatsappCitasNumber,
  clinic.whatsappNumber
);
const mapsUrl = safeCmsUrl(business?.mapsUrl, clinic.googleMapsUrl);

const serviceChips = [
  { key: "podologia", label: "Podologia" },
  { key: "psicologia", label: "Psicologia" },
  { key: "optica", label: "Optica" },
  { key: "quiropractica", label: "Quiropractica" },
  { key: "dentista", label: "Dentista" },
];

function socialHandle(rawUrl: string): string {
  try {
    const url = new URL(rawUrl);
    const path = url.pathname.replace(/\/+$/, "");
    const last = path.split("/").filter(Boolean).pop();
    if (!last) return rawUrl;
    return last.startsWith("@") ? last : `@${last}`;
  } catch {
    return rawUrl;
  }
}

const primaryWaMessage = buildContactMessage({
  reason: resolveWhatsAppReason(
    business?.whatsappGeneralMessage,
    "Quiero informacion y agendar una cita.",
    {
      business: business?.name || clinic.name,
      problem: business?.whatsappQuickProblemDefault || "",
    }
  ),
});
const waPrimaryHref = buildWhatsAppUrl(primaryWaMessage, waNumber);

const socialItems = [
  { label: "Facebook", value: safeCmsUrl(business?.facebookUrl, "") },
  { label: "Instagram", value: safeCmsUrl(business?.instagramUrl, "") },
  { label: "TikTok", value: safeCmsUrl(business?.tiktokUrl, "") },
]
  .filter((x) => Boolean(x.value))
  .map((x) => ({ ...x, handle: socialHandle(String(x.value)) }));
---

<section class="rounded-2xl border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-950">
  <h2 class="text-xl font-semibold">Contacto</h2>
  <div class="mt-4 grid gap-2 text-sm text-slate-700 dark:text-slate-300">
    <p><span class="font-semibold">Direccion:</span> {address}</p>
    <p><span class="font-semibold">Telefono:</span> <a class="text-sky-700 hover:underline dark:text-sky-300" href={`tel:${phoneTel}`}>{phoneDisplay}</a></p>
    <p><span class="font-semibold">WhatsApp:</span> <a class="text-sky-700 hover:underline dark:text-sky-300" href={waPrimaryHref} target="_blank" rel="noopener noreferrer">{waNumber}</a></p>
  </div>

  <div class="mt-6 flex flex-wrap gap-3">
    <a class="btn-base btn-primary" href={waPrimaryHref} target="_blank" rel="noopener noreferrer">Enviar WhatsApp</a>
    <a class="btn-base btn-secondary" href={`tel:${phoneTel}`}>Llamar</a>
    <a class="btn-base btn-secondary" href={mapsUrl} target="_blank" rel="noopener noreferrer">Abrir en Maps</a>
    <a class="btn-base btn-secondary" href="/agendar">Agendar en web</a>
    <button id="copy-address-contact" type="button" class="btn-base btn-secondary">Copiar direccion</button>
  </div>

  <div class="mt-5">
    <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500 dark:text-slate-400">Selecciona servicio</p>
    <div class="mt-2 flex flex-wrap gap-2">
      {serviceChips.map((chip) => {
        const href = buildWhatsAppUrl(
          buildContactMessage({
            service: chip.label,
            reason: resolveWhatsAppReason(
              business?.whatsappGeneralMessage,
              "Quiero informacion y agendar este servicio.",
              {
                service: chip.label,
                business: business?.name || clinic.name,
                problem: business?.whatsappQuickProblemDefault || "",
              }
            ),
          }),
          waNumber
        );
        return (
          <a
            class="rounded-full border border-slate-300 px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-900"
            href={href}
            target="_blank"
            rel="noopener noreferrer"
          >
            {chip.label}
          </a>
        );
      })}
    </div>
  </div>

  {socialItems.length > 0 && (
    <div class="mt-6 border-t border-slate-200 pt-4 dark:border-slate-800">
      <p class="text-xs font-semibold uppercase tracking-[0.14em] text-slate-500 dark:text-slate-400">Redes</p>
      <div class="mt-2 flex flex-wrap gap-2 text-sm">
        {socialItems.map((item) => (
          <a class="text-sky-700 hover:underline dark:text-sky-300" href={item.value} target="_blank" rel="noopener noreferrer">
            {item.label}: {item.handle}
          </a>
        ))}
      </div>
    </div>
  )}
</section>

<script is:inline define:vars={{ address }}>
  const copyBtn = document.getElementById("copy-address-contact");
  if (copyBtn) {
    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(String(address || ""));
        copyBtn.textContent = "Direccion copiada";
      } catch {
        copyBtn.textContent = "No se pudo copiar";
      }
      setTimeout(() => {
        copyBtn.textContent = "Copiar direccion";
      }, 1600);
    });
  }
</script>
